!function(e){var t={};function r(o){if(t[o])return t[o].exports;var i=t[o]={i:o,l:!1,exports:{}};return e[o].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(o,i,function(t){return e[t]}.bind(null,i));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/",r(r.s=9)}([function(e,t){e.exports=require("reflect-metadata")},function(e,t){e.exports=require("typedi")},function(e,t,r){"use strict";var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const i=o(r(22));t.LoggerService=i.default;const n=o(r(24));t.SettingService=n.default;const s=o(r(26));t.SocketManagerService=s.default;const c=o(r(4));t.StorageService=c.default},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),r(0);const o=r(2);t.SettingService=o.SettingService,t.StorageService=o.StorageService,t.LoggerService=o.LoggerService,t.SocketManagerService=o.SocketManagerService},function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var i,n=arguments.length,s=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0});const n=r(27),{dataType:s}=r(8);r(0);const c=r(1),a=r(2),l=r(5);let u=class extends l.EventEmitter{constructor(e,t){super(),this.logger=e,this.settingSrv=t,this.logger.info("created StorageSrv"),this.dbname=this.settingSrv.getSystemDbName()}init(){return new Promise((e,t)=>{this.connect(this.dbname).then(t=>{this.db=t,this.logger.info(`Connected to the ${this.dbname} database.`),e()},e=>{t(e)})})}connect(e){return this.logger.info(`try load sqlite : ${e}`),this.logger.sql=this.sqlLogger.bind(this),new Promise((e,t)=>{const r={mod:{log:this.logger,type:s},interfaces:{SeederInterface:{},MigratorInterfrace:{}}},o={driver:"sqlite3",filename:this.dbname};n.connect(o,r,(r,o)=>{r?t(r):(o.all("PRAGMA foreign_keys=ON"),e(o))})})}sqlLogger(){}};u=o([c.Service(),i("design:paramtypes",[a.LoggerService,a.SettingService])],u),t.default=u},function(e,t){e.exports=require("events")},function(e,t){e.exports=require("routing-controllers")},function(e,t){e.exports=require("socket-controllers")},function(e,t){e.exports=require("db-migrate-shared")},function(e,t,r){"use strict";var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),new(o(r(10)).default)(process.env.PORT).runServ()},function(e,t,r){"use strict";(function(e){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))(function(i,n){function s(e){try{a(o.next(e))}catch(e){n(e)}}function c(e){try{a(o.throw(e))}catch(e){n(e)}}function a(e){e.done?i(e.value):new r(function(t){t(e.value)}).then(s,c)}a((o=o.apply(e,t||[])).next())})},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),r(0),r(11);const n=r(6),s=r(7),c=r(1),a=i(r(12)),l=i(r(13)),u=i(r(14)),f=r(15),g=r(16),d=r(17),p=r(18),h=r(19);r(20);const v=r(3),m=r(5),y=i(r(29));t.default=class extends m.EventEmitter{constructor(t){const o=p.join("dist","public");super(),n.useContainer(c.Container),s.useContainer(c.Container),this.app=l.default(),this.app.use(d()),this.app.engine("html",r(31).renderFile),this.app.set("views",p.join(o)),this.app.set("view engine","html"),n.useExpressServer(this.app),this.server=a.default.createServer(this.app),this.app.use("/public",l.default.static(o)),this.io=u.default(this.server),this.io.use((e,t)=>{console.log("Custom middleware"),t()}),console.log(e),s.useSocketServer(this.io,{controllers:[p.join(e,"controllers","websocket","*.js")]});const i=c.Container.get(v.LoggerService);i.info(`\n${g.textSync("Sample")}`),this.app.use(f("combined",{stream:i})),this.addServices(),this.port=t?parseInt(t,10):c.Container.get(v.SettingService).getPort()}addMiddleware(e){this.app.use(e)}addServices(){return o(this,void 0,void 0,function*(){const e=[{name:"socketIO",instance:this.io}],t=c.Container.get(v.LoggerService);for(const{name:r,instance:o}of e)c.Container.set(r,o),t.info(`[init] DI Registered ${r}`);const r=[v.SettingService,v.StorageService,y.default,v.SocketManagerService];for(const e of r)try{const r=c.Container.get(e);yield r.init(),t.info(`[Serivce Initialize] DI Registered ${e.name}`)}catch(e){console.log(e.stack),t.error(e)}this.emit("ready")})}getApp(){return this.app}runServ(){const e=c.Container.get(v.LoggerService);return new Promise(t=>{this.once("ready",()=>o(this,void 0,void 0,function*(){t(this.server.listen(this.port,()=>e.info(`listening on port ${this.port}`))),yield h("http://localhost:4000")}))})}}}).call(this,"server")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),r(0)},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("socket.io")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("figlet")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("open")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),r(21),r(28)},function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var i,n=arguments.length,s=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),r(0);const n=r(6),s=r(3);let c=class{constructor(e){this.loggerSrv=e,this.loggerSrv.info("created RootController")}helloServer(){}getApi(){return[{hello:"Hello Node.js Express Server"}]}};o([n.Get("/"),n.Render("index.html"),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",void 0)],c.prototype,"helloServer",null),o([n.Get("/api"),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",void 0)],c.prototype,"getApi",null),c=o([n.Controller(""),i("design:paramtypes",[s.LoggerService])],c),t.RootController=c},function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var i,n=arguments.length,s=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),r(0);const n=r(23);let s=class{constructor(){this.logger=n.createLogger({format:n.format.combine(n.format.timestamp({format:"YYYY-MM-DD HH:mm:ss"}),n.format(e=>"error"===e.level?Object.assign({},e,{message:`${e.timestamp} ${e.stack}`}):e)(),n.format.printf(({timestamp:e,level:t,message:r,meta:o})=>o?`${e} ${t} [${o.filename}:${o.line}]: ${r}`:`${e} ${t} ${r}`)),transports:[new n.transports.Console({level:"debug",handleExceptions:!0}),new n.transports.File({filename:"error.log",level:"error"}),new n.transports.File({filename:"system.log"})],exitOnError:!1})}init(){this.logger.info("created LoggerSrv")}write(e,t){this.logger.info(e)}alert(e,t=3){this.logger.alert(e)}crit(e,t=3){this.logger.crit(e)}data(e,t=3){this.logger.data(e)}debug(e,t=3){this.logger.debug(e)}error(e,t=3){this.logger.error(e)}help(e,t=3){this.logger.help(e)}input(e,t=3){this.logger.input(e)}info(e,t=3){this.logger.info(e)}log(e,t,r=3){this.logger.log(e,t)}notice(e,t=3){this.logger.notice(e)}sql(e,t=3){this.debug(e,t)}prompt(e,t=3){this.logger.prompt(e)}silly(e,t=3){this.logger.silly(e)}verbose(e,t=3){this.logger.verbose(e)}warn(e,t=3){this.logger.warn(e)}warning(e,t=3){this.logger.warning(e)}};s=o([r(1).Service(),i("design:paramtypes",[])],s),t.default=s},function(e,t){e.exports=require("winston")},function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var i,n=arguments.length,s=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),r(0);const n=r(1),s=r(2);let c=class{constructor(e){this.logger=e,this.logger.info("created SettingSrv"),this.settings=this.loadSettingFile()}init(){return Promise.resolve()}uid(e){return e=e||7,Math.random().toString(35).substr(2,e)}loadSettingFile(){return r(25)}getPort(){return this.settings.port}getSystemDbName(){return this.settings.sqlite}getSettings(){return this.settings}};c=o([n.Service(),i("design:paramtypes",[s.LoggerService])],c),t.default=c},function(e){e.exports={port:4e3,sqlite:"database.db",default:{destinations:[{receiver:"websocket",info:{}}]}}},function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var i,n=arguments.length,s=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),r(0);const n=r(1),s=r(2);let c=class{constructor(e){this.logger=e,this.sockets={},this.logger.info("created SocketMangerSrv")}init(){return Promise.resolve()}addSocket(e){const{id:t}=e;this.sockets[t]=e,this.logger.info(`registerd ${t}`)}delSocket(e){this.logger.info(`unregisterd ${e}`),delete this.sockets[e]}getSocket(e){return this.sockets[e]}isExistSocket(e){return!!this.sockets[e]}getAll(){return this.sockets}emitAll(e,t){for(const r in this.sockets){this.sockets[r].emit(e,t)}}};c=o([n.Service(),i("design:paramtypes",[s.LoggerService])],c),t.default=c},function(e,t){e.exports=require("db-migrate-sqlite3")},function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var i,n=arguments.length,s=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0});const s=r(7),c=r(3);let a=class{constructor(e,t){this.sockMgrSrv=e,this.loggerSrv=t,this.loggerSrv.info("created WsMessageController")}connection(e){this.sockMgrSrv.addSocket(e),this.loggerSrv.info("client connected")}disconnect(e){const{id:t}=e;this.sockMgrSrv.delSocket(t)}};o([s.OnConnect(),n(0,s.ConnectedSocket()),i("design:type",Function),i("design:paramtypes",[Object]),i("design:returntype",void 0)],a.prototype,"connection",null),o([s.OnDisconnect(),n(0,s.ConnectedSocket()),i("design:type",Function),i("design:paramtypes",[Object]),i("design:returntype",void 0)],a.prototype,"disconnect",null),a=o([s.SocketController("/ws"),i("design:paramtypes",[c.SocketManagerService,c.LoggerService])],a),t.WsMessageController=a},function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var i,n=arguments.length,s=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),r(0);const s=r(1),c=r(5),a=n(r(30)),l=n(r(4)),u=r(2);let f=class extends c.EventEmitter{constructor(e,t,r){super(),this.logger=e,this.storageSrv=t,this.migrationLogRepository=r,this.migrations=[],this.logger.info("created StorageMigrationSrv")}init(){const e={};return this.migrationLogRepository.getMigrationLog().then(t=>{for(const r of t)r.success&&(e[r.migration_id]=r);return e}).then(e=>{this.addMigrations(),this.dbMigration(e)})}addMigration(e,t,r){this.migrations.push({migration_id:e,action:t,args:r})}addMigrations(){const e=[this.migrationLogRepository.migrations()];for(const t of e)this.migrations=this.migrations.concat(t)}dbMigration(e){for(const{migration_id:t,action:r,args:o}of this.migrations)if(!e[t]){this.logger.info(`execute ${t}`);const e=o[o.length-1];o[o.length-1]=(...i)=>{const[n]=i,s=!n,c=n?n.message.replace(/\"/gi,"'"):"",a=JSON.stringify(o.slice(0,o.length-1)).replace(/\"/gi,"'");this.storageSrv.db.insert("migration_log",["migration_id","action","success","error","params"],[t,r,s,c,a],e=>{e&&this.logger.error(e)}),e.apply(this.storageSrv.db,i)};try{this.storageSrv.db[r].apply(this.storageSrv.db,o)}catch(e){this.logger.error(e)}}}};f=o([s.Service(),i("design:paramtypes",[u.LoggerService,l.default,a.default])],f),t.default=f},function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var i,n=arguments.length,s=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var c=e.length-1;c>=0;c--)(i=e[c])&&(s=(n<3?i(s):n>3?i(t,r,s):i(t,r))||s);return n>3&&s&&Object.defineProperty(t,r,s),s},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),r(0);const s=r(1),c=n(r(4)),a=r(2),{dataType:l}=r(8);let u=class{constructor(e,t){this.logger=e,this.storageSrv=t,this.tableName="migration_log",this.logger.info("created Migration_logRepository")}init(){return Promise.resolve()}migrations(){return[{migration_id:"create table migration_log",action:"createTable",args:[this.tableName,{id:{type:l.INTEGER,primaryKey:!0,autoIncrement:!0,notNull:!0},migration_id:{type:l.STRING,length:255},action:{type:l.STRING,notNull:!0,length:20},params:{type:l.TEXT,notNull:!0,defaultValue:""},success:{type:l.BOOLEAN,notNull:!0},error:{type:l.TEXT,defaultValue:""},timestamp:{type:l.DATE_TIME,defaultValue:new String("CURRENT_TIMESTAMP")}},e=>{e&&this.logger.error(e)}]}]}getMigrationLog(){return new Promise(e=>{const{db:t}=this.storageSrv;t.all("select * from migration_log",(t,r)=>{e(t?[]:r)})})}};u=o([s.Service(),i("design:paramtypes",[a.LoggerService,c.default])],u),t.default=u},function(e,t){e.exports=require("ejs")}]);
//# sourceMappingURL=server.bundle.js.map