!function(e){var t={};function r(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(o,n,function(t){return e[t]}.bind(null,n));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="/",r(r.s=9)}([function(e,t){e.exports=require("reflect-metadata")},function(e,t){e.exports=require("typedi")},function(e,t,r){"use strict";var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=o(r(21));t.LoggerSrv=n.default;const i=o(r(23));t.SettingSrv=i.default;const s=o(r(25));t.SocketManagerSrv=s.default;const a=o(r(4));t.StorageSrv=a.default},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),r(0);const o=r(2);t.SettingSrv=o.SettingSrv,t.StorageSrv=o.StorageSrv,t.LoggerSrv=o.LoggerSrv,t.SocketManagerSrv=o.SocketManagerSrv},function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,i=arguments.length,s=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(i<3?n(s):i>3?n(t,r,s):n(t,r))||s);return i>3&&s&&Object.defineProperty(t,r,s),s},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0});const i=r(26),{dataType:s}=r(8);r(0);const a=r(1),c=r(2),l=r(5);let u=class extends l.EventEmitter{constructor(e,t){super(),this.logger=e,this.settingSrv=t,this.logger.info("created StorageSrv"),this.dbname=this.settingSrv.getSystemDbName()}init(){return new Promise((e,t)=>{this.connect(this.dbname).then(t=>{this.db=t,this.logger.info(`Connected to the ${this.dbname} database.`),e()},e=>{t(e)})})}connect(e){return this.logger.info(`try load sqlite : ${e}`),this.logger.sql=this.sqlLogger.bind(this),new Promise((e,t)=>{const r={mod:{log:this.logger,type:s},interfaces:{SeederInterface:{},MigratorInterfrace:{}}},o={driver:"sqlite3",filename:this.dbname};i.connect(o,r,(r,o)=>{r?t(r):(o.all("PRAGMA foreign_keys=ON"),e(o))})})}sqlLogger(){}};u=o([a.Service(),n("design:paramtypes",[c.LoggerSrv,c.SettingSrv])],u),t.default=u},function(e,t){e.exports=require("events")},function(e,t){e.exports=require("routing-controllers")},function(e,t){e.exports=require("socket-controllers")},function(e,t){e.exports=require("db-migrate-shared")},function(e,t,r){"use strict";var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),new(o(r(10)).default)(process.env.PORT).runServ()},function(e,t,r){"use strict";(function(e){var o=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))(function(n,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){e.done?n(e.value):new r(function(t){t(e.value)}).then(s,a)}c((o=o.apply(e,t||[])).next())})},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),r(0),r(11);const i=r(6),s=r(7),a=r(1),c=n(r(12)),l=n(r(13)),u=n(r(14)),f=r(15),g=r(16),d=r(17),p=r(18);r(19);const h=r(3),v=r(5),m=n(r(28));t.default=class extends v.EventEmitter{constructor(t){const o=p.join("dist","public");super(),i.useContainer(a.Container),s.useContainer(a.Container),this.app=l.default(),this.app.use(d()),this.app.engine("html",r(30).renderFile),this.app.set("views",p.join(o)),this.app.set("view engine","html"),i.useExpressServer(this.app),this.server=c.default.createServer(this.app),this.app.use("/public",l.default.static(o)),this.io=u.default(this.server),this.io.use((e,t)=>{console.log("Custom middleware"),t()}),console.log(e),s.useSocketServer(this.io,{controllers:[p.join(e,"controllers","websocket","*.js")]});const n=a.Container.get(h.LoggerSrv);n.info(`\n${g.textSync("Sample")}`),this.app.use(f("combined",{stream:n})),this.addServices(),this.port=t?parseInt(t,10):a.Container.get(h.SettingSrv).getPort()}addMiddleware(e){this.app.use(e)}addServices(){return o(this,void 0,void 0,function*(){const e=[{name:"socketIO",instance:this.io}],t=a.Container.get(h.LoggerSrv);for(const{name:r,instance:o}of e)a.Container.set(r,o),t.info(`[init] DI Registered ${r}`);const r=[h.SettingSrv,h.StorageSrv,m.default,h.SocketManagerSrv];for(const e of r)try{const r=a.Container.get(e);yield r.init(),t.info(`[Serivce Initialize] DI Registered ${e.name}`)}catch(e){console.log(e.stack),t.error(e)}this.emit("ready")})}getApp(){return this.app}runServ(){const e=a.Container.get(h.LoggerSrv);return new Promise(t=>{this.once("ready",()=>{t(this.server.listen(this.port,()=>e.info(`listening on port ${this.port}`)))})})}}}).call(this,"server")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),r(0)},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("socket.io")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("figlet")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("path")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),r(20),r(27)},function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,i=arguments.length,s=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(i<3?n(s):i>3?n(t,r,s):n(t,r))||s);return i>3&&s&&Object.defineProperty(t,r,s),s},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),r(0);const i=r(6),s=r(3);let a=class{constructor(e){this.loggerSrv=e,this.loggerSrv.info("created RootController")}helloServer(){}getApi(){return[{hello:"Hello Node.js Express Server"}]}};o([i.Get("/"),i.Render("index.html"),n("design:type",Function),n("design:paramtypes",[]),n("design:returntype",void 0)],a.prototype,"helloServer",null),o([i.Get("/api"),n("design:type",Function),n("design:paramtypes",[]),n("design:returntype",void 0)],a.prototype,"getApi",null),a=o([i.Controller(""),n("design:paramtypes",[s.LoggerSrv])],a),t.RootController=a},function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,i=arguments.length,s=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(i<3?n(s):i>3?n(t,r,s):n(t,r))||s);return i>3&&s&&Object.defineProperty(t,r,s),s},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),r(0);const i=r(22);let s=class{constructor(){this.logger=i.createLogger({format:i.format.combine(i.format.timestamp({format:"YYYY-MM-DD HH:mm:ss"}),i.format(e=>"error"===e.level?Object.assign({},e,{message:`${e.timestamp} ${e.stack}`}):e)(),i.format.printf(({timestamp:e,level:t,message:r,meta:o})=>o?`${e} ${t} [${o.filename}:${o.line}]: ${r}`:`${e} ${t} ${r}`)),transports:[new i.transports.Console({level:"debug",handleExceptions:!0}),new i.transports.File({filename:"error.log",level:"error"}),new i.transports.File({filename:"system.log"})],exitOnError:!1})}init(){this.logger.info("created LoggerSrv")}write(e,t){this.logger.info(e)}alert(e,t=3){this.logger.alert(e)}crit(e,t=3){this.logger.crit(e)}data(e,t=3){this.logger.data(e)}debug(e,t=3){this.logger.debug(e)}error(e,t=3){this.logger.error(e)}help(e,t=3){this.logger.help(e)}input(e,t=3){this.logger.input(e)}info(e,t=3){this.logger.info(e)}log(e,t,r=3){this.logger.log(e,t)}notice(e,t=3){this.logger.notice(e)}sql(e,t=3){this.debug(e,t)}prompt(e,t=3){this.logger.prompt(e)}silly(e,t=3){this.logger.silly(e)}verbose(e,t=3){this.logger.verbose(e)}warn(e,t=3){this.logger.warn(e)}warning(e,t=3){this.logger.warning(e)}};s=o([r(1).Service(),n("design:paramtypes",[])],s),t.default=s},function(e,t){e.exports=require("winston")},function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,i=arguments.length,s=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(i<3?n(s):i>3?n(t,r,s):n(t,r))||s);return i>3&&s&&Object.defineProperty(t,r,s),s},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),r(0);const i=r(1),s=r(2);let a=class{constructor(e){this.logger=e,this.logger.info("created SettingSrv"),this.settings=this.loadSettingFile()}init(){return Promise.resolve()}uid(e){return e=e||7,Math.random().toString(35).substr(2,e)}loadSettingFile(){return r(24)}getPort(){return this.settings.port}getSystemDbName(){return this.settings.sqlite}getSettings(){return this.settings}};a=o([i.Service(),n("design:paramtypes",[s.LoggerSrv])],a),t.default=a},function(e){e.exports={port:4e3,sqlite:"database.db",default:{destinations:[{receiver:"websocket",info:{}}]}}},function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,i=arguments.length,s=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(i<3?n(s):i>3?n(t,r,s):n(t,r))||s);return i>3&&s&&Object.defineProperty(t,r,s),s},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),r(0);const i=r(1),s=r(2);let a=class{constructor(e){this.logger=e,this.sockets={},this.logger.info("created SocketMangerSrv")}init(){return Promise.resolve()}addSocket(e){const{id:t}=e;this.sockets[t]=e,this.logger.info(`registerd ${t}`)}delSocket(e){this.logger.info(`unregisterd ${e}`),delete this.sockets[e]}getSocket(e){return this.sockets[e]}isExistSocket(e){return!!this.sockets[e]}getAll(){return this.sockets}emitAll(e,t){for(const r in this.sockets){this.sockets[r].emit(e,t)}}};a=o([i.Service(),n("design:paramtypes",[s.LoggerSrv])],a),t.default=a},function(e,t){e.exports=require("db-migrate-sqlite3")},function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,i=arguments.length,s=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(i<3?n(s):i>3?n(t,r,s):n(t,r))||s);return i>3&&s&&Object.defineProperty(t,r,s),s},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},i=this&&this.__param||function(e,t){return function(r,o){t(r,o,e)}};Object.defineProperty(t,"__esModule",{value:!0});const s=r(7),a=r(3);let c=class{constructor(e,t){this.sockMgrSrv=e,this.loggerSrv=t,this.loggerSrv.info("created WsMessageController")}connection(e){this.sockMgrSrv.addSocket(e),this.loggerSrv.info("client connected")}disconnect(e){const{id:t}=e;this.sockMgrSrv.delSocket(t)}};o([s.OnConnect(),i(0,s.ConnectedSocket()),n("design:type",Function),n("design:paramtypes",[Object]),n("design:returntype",void 0)],c.prototype,"connection",null),o([s.OnDisconnect(),i(0,s.ConnectedSocket()),n("design:type",Function),n("design:paramtypes",[Object]),n("design:returntype",void 0)],c.prototype,"disconnect",null),c=o([s.SocketController("/ws"),n("design:paramtypes",[a.SocketManagerSrv,a.LoggerSrv])],c),t.WsMessageController=c},function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,i=arguments.length,s=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(i<3?n(s):i>3?n(t,r,s):n(t,r))||s);return i>3&&s&&Object.defineProperty(t,r,s),s},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),r(0);const s=r(1),a=r(5),c=i(r(29)),l=i(r(4)),u=r(2);let f=class extends a.EventEmitter{constructor(e,t,r){super(),this.logger=e,this.storageSrv=t,this.migrationLogRepository=r,this.migrations=[],this.logger.info("created StorageMigrationSrv")}init(){const e={};return this.migrationLogRepository.getMigrationLog().then(t=>{for(const r of t)r.success&&(e[r.migration_id]=r);return e}).then(e=>{this.addMigrations(),this.dbMigration(e)})}addMigration(e,t,r){this.migrations.push({migration_id:e,action:t,args:r})}addMigrations(){const e=[this.migrationLogRepository.migrations()];for(const t of e)this.migrations=this.migrations.concat(t)}dbMigration(e){for(const{migration_id:t,action:r,args:o}of this.migrations)if(!e[t]){this.logger.info(`execute ${t}`);const e=o[o.length-1];o[o.length-1]=(...n)=>{const[i]=n,s=!i,a=i?i.message.replace(/\"/gi,"'"):"",c=JSON.stringify(o.slice(0,o.length-1)).replace(/\"/gi,"'");this.storageSrv.db.insert("migration_log",["migration_id","action","success","error","params"],[t,r,s,a,c],e=>{e&&this.logger.error(e)}),e.apply(this.storageSrv.db,n)};try{this.storageSrv.db[r].apply(this.storageSrv.db,o)}catch(e){this.logger.error(e)}}}};f=o([s.Service(),n("design:paramtypes",[u.LoggerSrv,l.default,c.default])],f),t.default=f},function(e,t,r){"use strict";var o=this&&this.__decorate||function(e,t,r,o){var n,i=arguments.length,s=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(i<3?n(s):i>3?n(t,r,s):n(t,r))||s);return i>3&&s&&Object.defineProperty(t,r,s),s},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),r(0);const s=r(1),a=i(r(4)),c=r(2),{dataType:l}=r(8);let u=class{constructor(e,t){this.logger=e,this.storageSrv=t,this.tableName="migration_log",this.logger.info("created Migration_logRepository")}init(){return Promise.resolve()}migrations(){return[{migration_id:"create table migration_log",action:"createTable",args:[this.tableName,{id:{type:l.INTEGER,primaryKey:!0,autoIncrement:!0,notNull:!0},migration_id:{type:l.STRING,length:255},action:{type:l.STRING,notNull:!0,length:20},params:{type:l.TEXT,notNull:!0,defaultValue:""},success:{type:l.BOOLEAN,notNull:!0},error:{type:l.TEXT,defaultValue:""},timestamp:{type:l.DATE_TIME,defaultValue:new String("CURRENT_TIMESTAMP")}},e=>{e&&this.logger.error(e)}]}]}getMigrationLog(){return new Promise((e,t)=>{this.storageSrv.db.all("select * from migration_log",(t,r)=>{e(t?[]:r)})})}};u=o([s.Service(),n("design:paramtypes",[c.LoggerSrv,a.default])],u),t.default=u},function(e,t){e.exports=require("ejs")}]);
//# sourceMappingURL=server.bundle.js.map